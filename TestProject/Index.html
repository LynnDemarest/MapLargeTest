<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Test Project : MapLarge</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.1/knockout-latest.js"></script>
    <script src="js/FileMan.js"></script>

    <!-- remove in production and replace with favicon.ico -->
    <link rel="shortcut icon" href="#">

    <link href="../css/main.css" rel="stylesheet" />
</head>
<body>
    <div id="knockoutContainer">
        <h1>MapLarge Programming Test</h1>

        <div style="display:flex;">
            <div style="width:500px;">
                <div id="statusMessage" class="statusMessage">
                    <span data-bind="text: statusMessage"></span>
                </div>

                <div id="divSearchResults" class="divSearchResults">
                    <div class="header" onclick="toggleNextDiv(this);">
                        Search Current Folder : (<span data-bind="text: numberOfSearchResults"></span>) <span id="searchfolder" data-bind="text: currentFolder()"></span>
                    </div>
                    <div id="divSearchBody">
                        <input type="text" data-bind="value: searchPhrase" />
                        <!--
                            <button class="clickable" data-bind="click: function() {doSearch();}">Search</button>
                        -->
                        <button class="clickable" data-bind="click: doSearch.bind();">Search</button>
                        <!--
                            <button class="clickable" data-bind="click: doSearch();">Search</button>
                        -->
                        <ul data-bind="foreach: searchResults">
                            <div style="display:flex;">
                                <div class="linenumber" data-bind="text: $index() + 1 + '. '"></div>
                                <img src="img/delete.svg" class="clickable deleteicon"
                                     data-bind="text: $data,
                                         click: $root.deleteFile" />
                                <img src="img/download.svg" class="clickable downloadicon" title="Download file"
                                     data-bind="text: $data,
                                     click: $root.downloadFile" />
                                <li class="clickable" data-bind="text: $data,
                                         click: $root.selectFile">
                                </li>
                            </div>
                        </ul>
                    </div>
                </div>
                <div>
                    <div class="currentfolder" style="display:flex;justify-content:space-between;">
                        <div>
                            Current Folder : <span id="rootFolder" data-bind="text: currentFolder"></span>
                        </div>
                        <div data-bind="if: canGoUp()">
                            <img src="img/upfolder.svg" alt="Go up one level." title="Go up one level."
                                 class="clickable goupicon"
                                 data-bind="click: function() {goUp();}"  onclick="event.stopPropagation()"/>
                        </div>
                    </div>
                </div>
                <div class="divDirectoryTree">
                    <div class="header"  onclick="toggleNextDiv(this);">
                        Tree View : <span data-bind="text: DirectoryTree().path"></span>
                        <span data-bind="if: DirectoryTree().path === ''">root</span>
                    </div>
                    <div>
                        <!-- DirectoryTree template -->
                        <script id="treeTemplate" type="text/html">
                            <ul class="folderUL">
                                <!--<div data-bind="if: $data.path !== undefined;">-->
                                <li class="folder clickable" data-bind="text: $data.path,
                                         click: $root.selectFolderObject,
                                         attr: {id: 'folder_' + $data.path }">
                                </li>
                                <!--</div>-->

                            <ul data-bind="foreach: $data.files" class="fileUL">

                                <li class="clickable file" draggable="true"
                                    data-bind="text: $root.getFileNameFromPath($data),
                                            click: $root.selectFile,
                                            attr: {id: 'file_' + $index(), fullpath: $data }">
                                </li>
                            </ul>
                            <!-- ko template: { name: 'treeTemplate', foreach: $data.folders } -->
                            <!-- /ko -->
                    </li>
                    </ul>
                    </script>
                    <!-- -->
                    <div data-bind="template: { name: 'treeTemplate', data: DirectoryTree() }"></div>
                </div>
            </div>
            <div class="divFolders">
                <div class="header" onclick="toggleNextDiv(this);">
                    <div style="display:flex;justify-content:space-between;">
                        <div>
                            Folders in <span data-bind="text: currentFolder"></span>: (<span data-bind="text: numberOfFolders"></span>)
                        </div>
                        <div>
                            <input type="text" id="newfolder" data-bind="value: newFolderName" onclick="event.stopPropagation()" />
                            <button class="AddButton" data-bind="click: addFolder"  onclick="event.stopPropagation()">Add</button>
                        </div>
                    </div>
                </div>
                <ul data-bind="foreach: folders">

                    <li class="folder clickable" data-bind="text: $data,
                                     click: $parent.selectFolder,
                                     attr: {id: 'folder_' + $index() }">

                    </li>
                </ul>
            </div>
            <div class="divFiles">
                <div class="header" onclick="toggleNextDiv(this);" style="display:flex;justify-content:space-between;">
                    <div>
                        Files in <span data-bind="text: currentFolder"></span> : (<span data-bind="text: numberOfFiles"></span>)
                    </div>
                    <div data-bind="if: currentFolderCanBeDeleted()">
                        <button data-bind="click: deleteFolder"  onclick="event.stopPropagation()">Delete Folder</button>
                    </div>
                </div>
                <ul data-bind="foreach: files">
                    <div style="display:flex;">
                        <div class="linenumber" data-bind="text: $index() + 1 + '. '"></div>
                        <img src="img/delete.svg" class="clickable deleteicon" title="Delete file"
                             data-bind="text: $data,
                                     click: $root.deleteFile" />
                        <img src="img/download.svg" class="clickable downloadicon" title="Download file"
                             data-bind="text: $data,
                                     click: $root.downloadFile" />
                        <li class="clickable file" draggable="true"
                            data-bind="text: $root.getFileNameFromPath($data),
                                click: $root.selectFile,
                                attr: {id: 'file_' + $index(), fullpath: $data }">
                        </li>
                    </div>
                </ul>
            </div>
            <div class="divUploadFiles" >
                <div class="header" onclick="toggleNextDiv(this);">
                    Upload Files to <span data-bind="text: currentFolder"></span>
                </div>
                <div class="uploadPanel">
                    <input type="file" id="FileUpload1" multiple />
                    <input type="button" id="btnUpload2" value="Upload Files"
                           data-bind="click: function () {$root.uploadFile();}" />
                </div>
            </div>
        </div>
        <div style="width:inherit;margin-left:1rem;">
            <div class="header" onclick="toggleNextDiv(this);" style="display:flex;justify-content:space-between;">
                <div>File Contents : <span data-bind="text: currentFile"></span></div>
                <img src="img/copy.svg" data-bind="click: function () {$root.copyToClipboard();}" class="clickable copyicon"
                     alt="Copy to clipboard" title="Copy to clipboard"  onclick="event.stopPropagation()" />
            </div>
            <div class="divShowFile">
                <pre style="width:100%;border:0px solid red;">
                <div data-bind="text: currentFileContents" id="currentFileContents"></div>
                    </pre>
            </div>
        </div>
    </div>
    <footer>
        Icon by <a href="https://freeicons.io/profile/3117">1273358166187522</a> on <a href="https://freeicons.io">freeicons.io</a>
    </footer>
    </div>
    <script>
        //alert("document.location = " + document.location);
        var searchPhrase;
        var rootFolder;
        [searchPhrase, rootFolder] = getDeepArgs();
        console.log("searchPhrase=" + searchPhrase + " rootFolder=" + rootFolder);
        // ko.options.useOnlyNativeEvents = true;
        //
        //
        //
        //var model = { viewModel: new FileManModel() };
        ko.applyBindings(new FileManModel(searchPhrase, rootFolder), document.querySelector("#knockoutContainer"));



        //
        // Takes the document.location and picks off arguments after the # symbol.
        // #searchphrase&rootFolder
        //
        function getDeepArgs() {
            var searchPhrase = "";
            var rootFolder = "";
            var url = document.location.href;
            if (url != "") {
                if (url.indexOf("#") != -1) {
                    //debugger;
                    var hashargs = url.split("#")[1];
                    var pieces = hashargs.split("&");
                    if (pieces.length > 0) {
                        searchPhrase = pieces[0];
                        if (pieces.length > 1) {
                            rootFolder = pieces[1];
                        }
                    }

                }
            }
            return [searchPhrase, rootFolder];
        }




        async function doUpload() {

            // Checking whether FormData is available in browser
            if (window.FormData !== undefined) {

                var fileUpload = $("#FileUpload1").get(0);
                var files = fileUpload.files;
                throw "No file selected to upload.";

                // Create FormData object
                var fileData = new FormData();

                // Looping over all files and add it to FormData object
                for (var i = 0; i < files.length; i++) {
                    fileData.append(files[i].name, files[i]);
                }

                // Adding one more key to FormData object
                var destinationFolder = document.getElementById("rootFolder").innerText;
                if (destinationFolder == "root") destinationFolder = ""; // TODO: ???
                fileData.append('destinationFolder', destinationFolder);

                await $.ajax({
                    url: '/Default/UploadFiles',
                    type: "POST",
                    contentType: false, // Not to set any content header
                    processData: false, // Not to process data
                    data: fileData,
                    success: function (result) {
                        //alert(result);
                        UpdateStatusMessage(result);
                    },
                    error: function (err) {
                        //alert(err.statusText);
                        UpdateStatusMessage(err.statusText);
                    }
                });
            } else {
                //alert("FormData is not supported.");
                UpdateStatusMessage("FormData is not supported.");
            }
        }

        //
        // (Used outside of knockout)
        //
        function UpdateStatusMessage(msg) {
            var obj = document.getElementById("statusMessage");
            obj.innerText = msg;
            if (msg == "")
                obj.classList.add("hidden");
            else
                obj.classList.remove("hidden");
        }

        function download(content, filename, contentType) {
            if (!contentType) contentType = 'application/octet-stream';
            var a = document.createElement('a');
            var blob = new Blob([content], { 'type': contentType });
            a.href = window.URL.createObjectURL(blob);
            a.download = filename;
            a.click();
        }


        $(document).ready(function () {
        });

        //
        //
        //
        function toggleNextDiv(obj) {
            var o = $(obj);
            if (obj.className == "header") {
                var nxt = o.next();
                nxt[0].hidden = !nxt[0].hidden;
            }
        }

        //
        // drag events
        //
        //var elementBeingDragged;
        //var elementBeingTargeted;

        function updateDragClassesAndHandlers() {
            const files = document.querySelectorAll(".file");
            for (var f of files) {
                f.addEventListener("dragstart", dragStart);
                f.addEventListener("dragend", dragEnd);
                //f.addEventListener("drop", dragDrop);
            }
            const folders = document.querySelectorAll('.folder');
            for (var d of folders) {
                d.addEventListener("dragover", dragOver)
                //d.addEventListener("dragenter", dragEnter)
                //d.addEventListener("dragleave", dragLeave)
                d.addEventListener("drop", dragDrop);
            }

        }
        function dragStart(e) {
            console.log("dragStart currentTarget.id = " + e.currentTarget.id);
            console.log("dragStart target.id = " + e.target.id);
            e.dataTransfer.setData("text", e.target.id);
            console.log("text set to " + e.target.id);
        }
        function dragEnd(e) {
            console.log("dragEnd currentTarget.id = " + e.currentTarget.id);
            console.log("dragEnd target.id = " + e.target.id);
            console.log("text = " + e.dataTransfer.getData("text"));

        }
        function dragDrop(e) {
            e.preventDefault();
            console.log("dragDrop target.id = " + e.target.id);  // folder_0
            console.log("dragDrop currentTarget = " + JSON.stringify(e.currentTarget));

            var file = e.dataTransfer.getData("text");
            console.log("text = " + file);

            var frompath, topath;
            frompath = document.getElementById(file).attributes.fullpath.textContent;
            topath = document.getElementById(e.target.id).innerText;
            alert("Would move " + frompath + " to " + topath);
        }
        function dragOver(e) {
            e.preventDefault();
            console.log("dragOver currentTarget.id = " + e.currentTarget.id);
            console.log("dragOver target.id = " + e.target.id);
        }
        function dragEnter(e) {
            e.preventDefault();
            console.log("dragEnter currentTarget.id = " + e.currentTarget.id);
            console.log("dragEnter target.id = " + e.target.id);
            e.currentTarget.classList.add("dragEnter");
            e.dataTransfer.setData("text", e.target.id);

        }
        function dragLeave(e) {
            console.log("dragLeave currentTarget.id = " + e.currentTarget.id);
            console.log("dragLeave target.id = " + e.target.id);
            e.currentTarget.classList.remove("dragEnter");
            //elementBeingTargeted = undefined;
        }

    </script>
</body>
</html>
